---
import Layout from "../../../layouts/DashboardLayout.astro";
import { useI18n } from "../../../i18n/utils";
// import Logo from "../../../assets/cannabis-logo.svg";
import { Icon } from "astro-icon/components";

const { t } = useI18n(Astro.url);
const { user } = Astro.locals;
---

<Layout user={user}>
  <div
    id="wizard-container"
    class="fixed top-0 left-0 w-screen h-screen bg-gradient-to-br from-primary-800 to-primary-600 dark:from-secondary-700 dark:to-secondary-400 overflow-hidden"
  >
    <!-- TODO: Add wizard title - user needs to know what they're doing -->
    <!-- Step 1: Strain Name -->
    <div
      class="absolute top-0 left-0 w-full h-full flex flex-col justify-between items-center opacity-0 translate-x-full transition-all duration-400 ease-in-out pointer-events-none"
      data-step="1"
    >
      <div
        class="flex-1 flex flex-col justify-center items-center p-8 text-center"
      >
        <div
          class="w-32 h-32 mb-8 drop-shadow-lg animate-bounce sm:w-20 sm:h-20"
        >
          <Icon name="tabler:cannabis" class="w-full h-full" />
        </div>
        <h2
          class="text-2xl font-bold text-primary-50 mb-4 drop-shadow-lg sm:text-xl"
        >
          {t("newStrain.strainNameLabel")}
        </h2>
        <div class="text-sm text-primary-50/80 font-medium">Step 1 of 5</div>
      </div>
      <div
        class="w-full max-w-128 p-8 bg-primary-50 dark:bg-secondary-50 rounded-t-3xl shadow-lg"
      >
        <input
          type="text"
          id="wizard-name"
          class="w-full p-5 text-lg border-2 border-primary-200 rounded-xl outline-none transition-all bg-primary-50 focus:border-primary-600 focus:bg-primary-50 focus:shadow-lg dark:bg-secondary-50 dark:border-secondary-200 dark:focus:border-secondary-600"
          placeholder={t("newStrain.strainPlaceholder")}
          data-field="name"
          autocomplete="off"
        />
        <button
          type="button"
          class="w-full p-5 text-lg font-semibold border-none rounded-xl cursor-pointer transition-all mt-4 bg-gradient-to-r from-primary-600 to-secondary-600 text-primary-50 shadow-lg hover:shadow-xl hover:-translate-y-1 active:translate-y-0"
          data-action="next"
        >
          Continue
        </button>
      </div>
    </div>

    <!-- Step 2: Strain Type -->
    <div
      class="absolute top-0 left-0 w-full h-full flex flex-col justify-between items-center opacity-0 translate-x-full transition-all duration-400 ease-in-out pointer-events-none"
      data-step="2"
    >
      <div
        class="flex-1 flex flex-col justify-center items-center p-8 text-center"
      >
        <div
          class="w-32 h-32 mb-8 drop-shadow-lg animate-bounce sm:w-20 sm:h-20"
        >
          <Icon name="tabler:cannabis" class="w-full h-full" />
        </div>
        <h2
          class="text-2xl font-bold text-primary-50 mb-4 drop-shadow-lg sm:text-xl"
        >
          {t("newStrain.strainTypeLabel")}
        </h2>
        <div class="text-sm text-primary-50/80 font-medium">Step 2 of 5</div>
      </div>
      <div
        class="w-full max-w-128 p-8 bg-primary-50 dark:bg-secondary-50 rounded-t-3xl shadow-lg"
      >
        <div class="flex flex-col gap-4">
          <button
            type="button"
            class="flex items-center gap-4 p-5 bg-primary-50 dark:bg-secondary-50 border-2 border-primary-200 dark:border-secondary-200 rounded-xl cursor-pointer transition-all font-medium text-lg hover:border-primary-600 dark:hover:border-secondary-600 hover:bg-primary-100 dark:hover:bg-secondary-100 hover:translate-x-1 text-primary-900 dark:text-secondary-900"
            data-value="sativa"
          >
            <span class="text-2xl">üåø</span>
            <span class="text-primary-900 dark:text-secondary-900">Sativa</span>
          </button>
          <button
            type="button"
            class="flex items-center gap-4 p-5 bg-primary-50 dark:bg-secondary-50 border-2 border-primary-200 dark:border-secondary-200 rounded-xl cursor-pointer transition-all font-medium text-lg hover:border-primary-600 dark:hover:border-secondary-600 hover:bg-primary-100 dark:hover:bg-secondary-100 hover:translate-x-1 text-primary-900 dark:text-secondary-900"
            data-value="indica"
          >
            <span class="text-2xl">üçÉ</span>
            <span class="text-primary-900 dark:text-secondary-900">Indica</span>
          </button>
          <button
            type="button"
            class="flex items-center gap-4 p-5 bg-primary-50 dark:bg-secondary-50 border-2 border-primary-200 dark:border-secondary-200 rounded-xl cursor-pointer transition-all font-medium text-lg hover:border-primary-600 dark:hover:border-secondary-600 hover:bg-primary-100 dark:hover:bg-secondary-100 hover:translate-x-1 text-primary-900 dark:text-secondary-900"
            data-value="hybrid"
          >
            <span class="text-2xl">üå±</span>
            <span class="text-primary-900 dark:text-secondary-900"
              >{t("newStrain.geneticsHybrid")}</span
            >
          </button>
        </div>
      </div>
    </div>

    <!-- Step 3: THC Content -->
    <div
      class="absolute top-0 left-0 w-full h-full flex flex-col justify-between items-center opacity-0 translate-x-full transition-all duration-400 ease-in-out pointer-events-none"
      data-step="3"
    >
      <div
        class="flex-1 flex flex-col justify-center items-center p-8 text-center"
      >
        <div
          class="w-32 h-32 mb-8 drop-shadow-lg animate-bounce sm:w-20 sm:h-20"
        >
          <Icon name="tabler:cannabis" class="w-full h-full" />
        </div>
        <h2
          class="text-2xl font-bold text-primary-50 mb-4 drop-shadow-lg sm:text-xl"
        >
          {t("newStrain.thcContentLabel")}
        </h2>
        <div class="text-sm text-primary-50/80 font-medium">Step 3 of 5</div>
      </div>
      <div
        class="w-full max-w-128 p-8 bg-primary-50 dark:bg-secondary-50 rounded-t-3xl shadow-lg"
      >
        <div class="flex items-center justify-center gap-6 mb-2">
          <button
            type="button"
            class="w-16 h-16 rounded-full border-2 border-primary-200 dark:border-secondary-200 bg-primary-50 dark:bg-secondary-50 text-2xl font-semibold text-primary-600 dark:text-secondary-600 cursor-pointer transition-all hover:bg-primary-600 dark:hover:bg-secondary-600 hover:text-primary-50 dark:hover:text-secondary-50 hover:border-primary-600 dark:hover:border-secondary-600 hover:scale-110 active:scale-95 flex items-center justify-center"
            data-action="decrease"
          >
            <span>‚àí</span>
          </button>
          <input
            type="number"
            id="wizard-thc"
            class="w-30 p-4 text-4xl font-bold text-center border-none bg-transparent text-primary-900 dark:text-secondary-900 outline-none sm:text-2xl"
            value="0"
            step="0.5"
            min="0"
            max="100"
            data-field="thc-content"
          />
          <button
            type="button"
            class="w-16 h-16 rounded-full border-2 border-primary-200 dark:border-secondary-200 bg-primary-50 dark:bg-secondary-50 text-2xl font-semibold text-primary-600 dark:text-secondary-600 cursor-pointer transition-all hover:bg-primary-600 dark:hover:bg-secondary-600 hover:text-primary-50 dark:hover:text-secondary-50 hover:border-primary-600 dark:hover:border-secondary-600 hover:scale-110 active:scale-95 flex items-center justify-center"
            data-action="increase"
          >
            <span>+</span>
          </button>
        </div>
        <div
          class="text-center text-base text-primary-500 dark:text-secondary-500 mb-4 font-medium"
        >
          % THC
        </div>
        <button
          type="button"
          class="w-full p-5 text-lg font-semibold border-none rounded-xl cursor-pointer transition-all mt-4 bg-gradient-to-r from-primary-600 to-secondary-600 text-primary-50 shadow-lg hover:shadow-xl hover:-translate-y-1 active:translate-y-0"
          data-action="next"
        >
          Continue
        </button>
      </div>
    </div>

    <!-- Step 4: CBD Content -->
    <div
      class="absolute top-0 left-0 w-full h-full flex flex-col justify-between items-center opacity-0 translate-x-full transition-all duration-400 ease-in-out pointer-events-none"
      data-step="4"
    >
      <div
        class="flex-1 flex flex-col justify-center items-center p-8 text-center"
      >
        <div
          class="w-32 h-32 mb-8 drop-shadow-lg animate-bounce sm:w-20 sm:h-20"
        >
          <Icon name="tabler:cannabis" class="w-full h-full" />
        </div>
        <h2
          class="text-2xl font-bold text-primary-50 mb-4 drop-shadow-lg sm:text-xl"
        >
          {t("newStrain.cbdContentLabel")}
        </h2>
        <div class="text-sm text-primary-50/80 font-medium">Step 4 of 5</div>
      </div>
      <div
        class="w-full max-w-128 p-8 bg-primary-50 dark:bg-secondary-50 rounded-t-3xl shadow-lg"
      >
        <div class="flex items-center justify-center gap-6 mb-2">
          <button
            type="button"
            class="w-16 h-16 rounded-full border-2 border-primary-200 dark:border-secondary-200 bg-primary-50 dark:bg-secondary-50 text-2xl font-semibold text-primary-600 dark:text-secondary-600 cursor-pointer transition-all hover:bg-primary-600 dark:hover:bg-secondary-600 hover:text-primary-50 dark:hover:text-secondary-50 hover:border-primary-600 dark:hover:border-secondary-600 hover:scale-110 active:scale-95 flex items-center justify-center"
            data-action="decrease"
          >
            <span>‚àí</span>
          </button>
          <input
            type="number"
            id="wizard-cbd"
            class="w-30 p-4 text-4xl font-bold text-center border-none bg-transparent text-primary-900 dark:text-secondary-900 outline-none sm:text-2xl"
            value="0"
            step="0.5"
            min="0"
            max="100"
            data-field="cbd-content"
          />
          <button
            type="button"
            class="w-16 h-16 rounded-full border-2 border-primary-200 dark:border-secondary-200 bg-primary-50 dark:bg-secondary-50 text-2xl font-semibold text-primary-600 dark:text-secondary-600 cursor-pointer transition-all hover:bg-primary-600 dark:hover:bg-secondary-600 hover:text-primary-50 dark:hover:text-secondary-50 hover:border-primary-600 dark:hover:border-secondary-600 hover:scale-110 active:scale-95 flex items-center justify-center"
            data-action="increase"
          >
            <span>+</span>
          </button>
        </div>
        <div
          class="text-center text-base text-primary-500 dark:text-secondary-500 mb-4 font-medium"
        >
          % CBD
        </div>
        <button
          type="button"
          class="w-full p-5 text-lg font-semibold border-none rounded-xl cursor-pointer transition-all mt-4 bg-gradient-to-r from-primary-600 to-secondary-600 text-primary-50 shadow-lg hover:shadow-xl hover:-translate-y-1 active:translate-y-0"
          data-action="next"
        >
          Continue
        </button>
      </div>
    </div>

    <!-- Step 5: Notes (Optional) -->
    <div
      class="absolute top-0 left-0 w-full h-full flex flex-col justify-between items-center opacity-0 translate-x-full transition-all duration-400 ease-in-out pointer-events-none"
      data-step="5"
    >
      <div
        class="flex-1 flex flex-col justify-center items-center p-8 text-center"
      >
        <div
          class="w-32 h-32 mb-8 drop-shadow-lg animate-bounce sm:w-20 sm:h-20"
        >
          <Icon name="tabler:cannabis" class="w-full h-full" />
        </div>
        <h2
          class="text-2xl font-bold text-primary-50 mb-4 drop-shadow-lg sm:text-xl"
        >
          {t("newStrain.notesLabel")}
        </h2>
        <div class="text-sm text-primary-50/80 font-medium">Step 5 of 5</div>
      </div>
      <div
        class="w-full max-w-128 p-8 bg-primary-50 dark:bg-secondary-50 rounded-t-3xl shadow-lg"
      >
        <textarea
          id="wizard-notes"
          class="w-full p-5 text-base border-2 border-primary-200 dark:border-secondary-200 rounded-xl outline-none transition-all bg-primary-50 dark:bg-secondary-50 resize-none font-inherit mb-4 focus:border-primary-600 dark:focus:border-secondary-600 focus:bg-primary-50 dark:focus:bg-secondary-50 focus:shadow-lg text-primary-900 dark:text-secondary-900"
          placeholder={t("newStrain.notesPlaceholder")}
          rows="4"
          data-field="notes"></textarea>
        <div class="grid grid-cols-3 gap-4 mt-4">
          <button
            type="button"
            class="p-5 text-lg font-semibold border-none rounded-xl cursor-pointer transition-all bg-primary-200 dark:bg-secondary-200 text-primary-700 dark:text-secondary-700 hover:bg-primary-300 dark:hover:bg-secondary-300"
            data-action="skip"
          >
            Skip
          </button>
          <button
            type="button"
            class="col-span-2 p-5 text-lg font-semibold border-none rounded-xl cursor-pointer transition-all bg-gradient-to-r from-primary-600 to-secondary-600 text-primary-50 shadow-lg hover:shadow-xl hover:-translate-y-1 active:translate-y-0"
            data-action="submit"
          >
            {t("newStrain.newStrainButton")}
          </button>
        </div>
      </div>
    </div>

    <!-- Hidden form for actual submission -->
    <form
      id="wizard-form"
      method="POST"
      action="/api/strains/add"
      style="display: none;"
    >
      <input type="hidden" name="name" id="form-name" />
      <input type="hidden" name="genetics" id="form-genetics" />
      <input type="hidden" name="thc-content" id="form-thc" />
      <input type="hidden" name="cbd-content" id="form-cbd" />
      <input type="hidden" name="notes" id="form-notes" />
    </form>
  </div>

  <script>
    class FocusedWizard {
      constructor() {
        this.currentStep = 1;
        this.totalSteps = 5;
        this.data = {};
        this.init();
      }

      init() {
        this.attachEventListeners();
        this.setActiveStep(1);
      }

      attachEventListeners() {
        // Next/Continue buttons
        document.querySelectorAll('[data-action="next"]').forEach((btn) => {
          btn.addEventListener("click", () => this.nextStep());
        });

        // Skip button
        document
          .querySelector('[data-action="skip"]')
          ?.addEventListener("click", () => {
            this.nextStep();
          });

        // Submit button
        document
          .querySelector('[data-action="submit"]')
          ?.addEventListener("click", () => {
            this.submit();
          });

        // Option buttons (Step 2: Genetics)
        document.querySelectorAll("[data-value]").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const value = e.currentTarget.dataset.value;
            this.data.genetics = value;

            // Visual feedback
            document
              .querySelectorAll("[data-value]")
              .forEach((b) =>
                b.classList.remove(
                  "border-primary-600",
                  "bg-gradient-to-r",
                  "from-primary-50",
                  "to-secondary-50",
                  "shadow-md",
                ),
              );
            e.currentTarget.classList.add(
              "border-primary-600",
              "bg-gradient-to-r",
              "from-primary-50",
              "to-secondary-50",
              "shadow-md",
            );

            // Auto-advance after selection
            setTimeout(() => this.nextStep(), 300);
          });
        });

        // Number controls (+/- buttons)
        document
          .querySelectorAll(
            '[data-action="decrease"], [data-action="increase"]',
          )
          .forEach((btn) => {
            btn.addEventListener("click", (e) => {
              const action = e.currentTarget.dataset.action;
              const input =
                e.currentTarget.parentElement.querySelector("input");
              const step = parseFloat(input.step) || 0.5;
              let value = parseFloat(input.value) || 0;

              if (action === "increase") {
                value += step;
              } else if (action === "decrease") {
                value = Math.max(0, value - step);
              }

              input.value = value.toFixed(1);
            });
          });

        // Enter key navigation
        document.addEventListener("keydown", (e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            if (this.currentStep === this.totalSteps) {
              this.submit();
            } else {
              this.nextStep();
            }
          }
        });

        // Store input values
        document.querySelectorAll("[data-field]").forEach((input) => {
          input.addEventListener("input", (e) => {
            const field = e.target.dataset.field;
            this.data[field] = e.target.value;
          });
        });
      }

      nextStep() {
        // Validate current step
        if (!this.validateStep()) {
          return;
        }

        // Collect data from current step
        this.collectStepData();

        if (this.currentStep < this.totalSteps) {
          this.goToStep(this.currentStep + 1);
        }
      }

      goToStep(stepNumber) {
        const currentStepEl = document.querySelector(
          `[data-step="${this.currentStep}"]`,
        );
        const nextStepEl = document.querySelector(
          `[data-step="${stepNumber}"]`,
        );

        if (!nextStepEl) return;

        // Remove active classes from current, add prev classes
        currentStepEl.classList.remove(
          "opacity-100",
          "translate-x-0",
          "pointer-events-auto",
        );
        currentStepEl.classList.add(
          "opacity-0",
          "-translate-x-full",
          "pointer-events-none",
        );

        // Add active classes to next, remove prev/inactive
        setTimeout(() => {
          nextStepEl.classList.remove(
            "opacity-0",
            "translate-x-full",
            "pointer-events-none",
            "-translate-x-full",
          );
          nextStepEl.classList.add(
            "opacity-100",
            "translate-x-0",
            "pointer-events-auto",
          );
          this.currentStep = stepNumber;
          this.focusCurrentInput();
        }, 50);
      }

      setActiveStep(stepNumber) {
        const stepEl = document.querySelector(`[data-step="${stepNumber}"]`);
        stepEl.classList.remove(
          "opacity-0",
          "translate-x-full",
          "pointer-events-none",
        );
        stepEl.classList.add(
          "opacity-100",
          "translate-x-0",
          "pointer-events-auto",
        );
        this.currentStep = stepNumber;
        this.focusCurrentInput();
      }

      validateStep() {
        if (this.currentStep === 1) {
          const nameInput = document.getElementById("wizard-name");
          if (!nameInput.value || nameInput.value.length < 2) {
            nameInput.classList.add("border-error");
            nameInput.focus();
            setTimeout(() => {
              nameInput.classList.remove("border-error");
            }, 1000);
            return false;
          }
        }
        return true;
      }

      collectStepData() {
        const currentStepEl = document.querySelector(
          `[data-step="${this.currentStep}"]`,
        );
        const inputs = currentStepEl.querySelectorAll("[data-field]");

        inputs.forEach((input) => {
          const field = input.dataset.field;
          this.data[field] = input.value;
        });
      }

      focusCurrentInput() {
        setTimeout(() => {
          const currentStepEl = document.querySelector(
            `[data-step="${this.currentStep}"]`,
          );
          const input = currentStepEl.querySelector(
            'input:not([type="hidden"]), textarea',
          );
          if (input && this.currentStep !== 2) {
            // Skip auto-focus for button selection step
            input.focus();
          }
        }, 450); // Wait for transition
      }

      submit() {
        // Collect final step data
        this.collectStepData();

        // Populate hidden form
        document.getElementById("form-name").value = this.data.name || "";
        document.getElementById("form-genetics").value =
          this.data.genetics || "hybrid";
        document.getElementById("form-thc").value =
          this.data["thc-content"] || "0";
        document.getElementById("form-cbd").value =
          this.data["cbd-content"] || "0";
        document.getElementById("form-notes").value = this.data.notes || "";

        // Submit the form
        document.getElementById("wizard-form").submit();
      }
    }

    // Initialize wizard
    new FocusedWizard();
  </script>
</Layout>
