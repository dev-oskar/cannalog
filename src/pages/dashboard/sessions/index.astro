---
import DashboardLayout from "../../../layouts/DashboardLayout.astro";
import { useI18n } from "../../../i18n/utils";
import CannabisIcon from "../../../components/ui/CannabisIcon.astro";
import type { Session } from "../../../types/db-types";
import { getUserSessions } from "../../../lib/queries.ts";
import { authUtils } from "../../../lib/nhost";
import PrimaryButton from "../../../components/ui/PrimaryButton.astro";
import SessionListItem from "../../../components/dashboard/SessionListItem.astro";

const { t, lang } = useI18n(Astro);
const user = await authUtils.getUser();

// Fetch sessions data
let sessions: Session[] = [];
let error;

try {
  sessions = await getUserSessions();
} catch (e) {
  console.error(e);
  error = "Failed to load sessions data";
}
---

<DashboardLayout title="Sessions" user={user}>
  <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
      <h1
        class="text-3xl font-bold tracking-tight text-gray-900 dark:text-white"
      >
        Sessions
      </h1>
      <div class="hidden sm:block">
        <PrimaryButton link="/dashboard/new-session" text="New session" />
      </div>
    </div>

    <!-- CTA for mobile -->
    <div class="sm:hidden mb-6">
      <PrimaryButton link="/dashboard/new-session" text="New session" block />
    </div>

    <!-- Error State -->
    {
      error && (
        <div
          class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative"
          role="alert"
        >
          <span class="block sm:inline">{error}</span>
        </div>
      )
    }

    <!-- Main Content: Sessions List or Empty State -->
    {
      sessions.length > 0 && !error ? (
        <div class="flow-root">
          <ul role="list" class="space-y-4">
            {sessions.map((session) => (
              <li>
                <SessionListItem session={session} lang={lang} />
              </li>
            ))}
          </ul>
        </div>
      ) : !error ? (
        <!-- Empty State -->
        <div class="text-center py-16 border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-lg">
          <CannabisIcon class="mx-auto h-12 w-12 text-gray-400" />
          <h3 class="mt-4 text-lg font-medium text-gray-900 dark:text-white">
            No sessions recorded
          </h3>
          <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
            Get started by creating a new session.
          </p>
          <div class="mt-6">
            <PrimaryButton
              link="/dashboard/new-session"
              text="New session"
            />
          </div>
        </div>
      ) : null
    }
  </div>
</DashboardLayout>
