---
import DashboardLayout from "../../../layouts/DashboardLayout.astro";
import { useI18n } from "../../../i18n/utils";
import { createNhostServerClient } from "../../../lib/nhost";
import { getUserStrains } from "../../../lib/queries";
import { Icon } from "astro-icon/components";

const { t } = useI18n(Astro.url);
const { user } = Astro.locals;
const nhost = await createNhostServerClient(Astro.cookies);

// Get user's strains for the strain selector
const userStrains = user ? await getUserStrains(nhost, user.id) : [];
---

<DashboardLayout title={t("sessions.new.title")} user={user}>
  <div
    id="wizard-container"
    class="fixed top-0 left-0 w-screen h-screen bg-gradient-to-br from-primary-800 to-primary-600 dark:from-secondary-700 dark:to-secondary-400 overflow-hidden"
  >
    <!-- Step 1: Select Strain -->
    <div
      class="absolute top-0 left-0 w-full h-full flex flex-col justify-between items-center opacity-0 translate-x-full transition-all duration-400 ease-in-out pointer-events-none"
      data-step="1"
    >
      <div
        class="flex-1 flex flex-col justify-center items-center p-8 text-center"
      >
        <div
          class="w-32 h-32 mb-8 drop-shadow-lg animate-bounce sm:w-20 sm:h-20"
        >
          <Icon name="tabler:cannabis" class="w-full h-full" />
        </div>
        <h2
          class="text-2xl font-bold text-primary-50 mb-4 drop-shadow-lg sm:text-xl"
        >
          {t("sessions.new.strain")}
        </h2>
        <div class="text-sm text-primary-50/80 font-medium">Step 1 of 5</div>
      </div>
      <div
        id="step-status"
        class="text-center mb-4 text-sm text-primary-50 whitespace-pre-line"
      >
      </div>
      <div
        class="w-full max-w-128 p-8 bg-primary-50 dark:bg-secondary-50 rounded-t-3xl shadow-lg"
      >
        {
          userStrains.length > 0 ? (
            <>
              <select
                data-field="strain"
                class="w-full p-5 text-lg border-2 text-primary-900 dark:text-secondary-900 border-primary-200 rounded-xl outline-none transition-all bg-primary-50 focus:border-primary-600 focus:bg-primary-50 focus:shadow-lg dark:bg-secondary-50 dark:border-secondary-200 dark:focus:border-secondary-600"
              >
                <option value="">{t("sessions.new.select_strain")}</option>
                {userStrains.map((strain) => (
                  <option value={strain.id}>{strain.name}</option>
                ))}
              </select>
              <button
                type="button"
                class="w-full p-5 text-lg font-semibold border-none rounded-xl cursor-pointer transition-all mt-4 bg-gradient-to-r from-primary-600 to-secondary-600 text-primary-50 shadow-lg hover:shadow-xl hover:-translate-y-1 active:translate-y-0"
                data-action="next"
              >
                Continue
              </button>
            </>
          ) : (
            <>
              <div class="text-center text-primary-900 dark:text-secondary-900 mb-4">
                <p class="text-lg font-medium mb-2">No strains found</p>
                <p class="text-base">
                  Create your first strain to start logging sessions.
                </p>
              </div>
              <a
                href="/dashboard/strains/new"
                class="w-full p-5 text-lg font-semibold border-none rounded-xl cursor-pointer transition-all bg-gradient-to-r from-primary-600 to-secondary-600 text-primary-50 shadow-lg hover:shadow-xl hover:-translate-y-1 active:translate-y-0 text-center block"
              >
                Create Strain
              </a>
            </>
          )
        }
      </div>
    </div>

    <!-- Step 2: Select Usage Method -->
    <div
      class="absolute top-0 left-0 w-full h-full flex flex-col justify-between items-center opacity-0 translate-x-full transition-all duration-400 ease-in-out pointer-events-none"
      data-step="2"
    >
      <div
        class="flex-1 flex flex-col justify-center items-center p-8 text-center"
      >
        <div
          class="w-32 h-32 mb-8 drop-shadow-lg animate-bounce sm:w-20 sm:h-20"
        >
          <Icon name="tabler:cannabis" class="w-full h-full" />
        </div>
        <h2
          class="text-2xl font-bold text-primary-50 mb-4 drop-shadow-lg sm:text-xl"
        >
          {t("sessions.new.usage_method")}
        </h2>
        <div class="text-sm text-primary-50/80 font-medium">Step 2 of 5</div>
      </div>
      <div
        id="step-status"
        class="text-center mb-4 text-sm text-primary-50 whitespace-pre-line"
      >
      </div>
      <div
        class="w-full max-w-128 p-8 bg-primary-50 dark:bg-secondary-50 rounded-t-3xl shadow-lg"
      >
        <div class="grid grid-cols-2 gap-4">
          <button
            type="button"
            class="flex flex-col items-center gap-4 p-5 bg-primary-50 dark:bg-secondary-50 border-2 border-primary-200 dark:border-secondary-200 rounded-xl cursor-pointer transition-all font-medium text-lg hover:border-primary-600 dark:hover:border-secondary-600 hover:bg-primary-100 dark:hover:bg-secondary-100 hover:translate-x-1 text-primary-900 dark:text-secondary-900"
            data-value="smoke"
          >
            <Icon name="la:joint" class="h-12 w-12" />
            <span>{t("sessions.methods.smoke")}</span>
          </button>
          <button
            type="button"
            class="flex flex-col items-center gap-4 p-5 bg-primary-50 dark:bg-secondary-50 border-2 border-primary-200 dark:border-secondary-200 rounded-xl cursor-pointer transition-all font-medium text-lg hover:border-primary-600 dark:hover:border-secondary-600 hover:bg-primary-100 dark:hover:bg-secondary-100 hover:translate-x-1 text-primary-900 dark:text-secondary-900"
            data-value="vape"
          >
            <Icon name="tabler:device-analytics" class="h-12 w-12" />
            <span>{t("sessions.methods.vape")}</span>
          </button>
          <button
            type="button"
            class="flex flex-col items-center gap-4 p-5 bg-primary-50 dark:bg-secondary-50 border-2 border-primary-200 dark:border-secondary-200 rounded-xl cursor-pointer transition-all font-medium text-lg hover:border-primary-600 dark:hover:border-secondary-600 hover:bg-primary-100 dark:hover:bg-secondary-100 hover:translate-x-1 text-primary-900 dark:text-secondary-900"
            data-value="edible"
          >
            <Icon name="la:cookie" class="h-12 w-12" />
            <span>{t("sessions.methods.edible")}</span>
          </button>
          <button
            type="button"
            class="flex flex-col items-center gap-4 p-5 bg-primary-50 dark:bg-secondary-50 border-2 border-primary-200 dark:border-secondary-200 rounded-xl cursor-pointer transition-all font-medium text-lg hover:border-primary-600 dark:hover:border-secondary-600 hover:bg-primary-100 dark:hover:bg-secondary-100 hover:translate-x-1 text-primary-900 dark:text-secondary-900"
            data-value="oil"
          >
            <Icon name="la:oil-can" class="h-12 w-12" />
            <span>{t("sessions.methods.oil")}</span>
          </button>
        </div>
        <div class="flex gap-4 mt-4">
          <button
            type="button"
            class="flex-1 p-5 text-lg font-semibold border-2 border-primary-200 dark:border-secondary-200 rounded-xl cursor-pointer transition-all bg-primary-50 dark:bg-secondary-50 text-primary-700 dark:text-secondary-700 hover:bg-primary-100 dark:hover:bg-secondary-100"
            data-action="back"
          >
            Back
          </button>
          <button
            type="button"
            class="flex-1 p-5 text-lg font-semibold border-none rounded-xl cursor-pointer transition-all bg-gradient-to-r from-primary-600 to-secondary-600 text-primary-50 shadow-lg hover:shadow-xl hover:-translate-y-1 active:translate-y-0"
            data-action="next"
          >
            Continue
          </button>
        </div>
      </div>
    </div>

    <!-- Step 3: Enter Amount -->
    <div
      class="absolute top-0 left-0 w-full h-full flex flex-col justify-between items-center opacity-0 translate-x-full transition-all duration-400 ease-in-out pointer-events-none"
      data-step="3"
    >
      <div
        class="flex-1 flex flex-col justify-center items-center p-8 text-center"
      >
        <div
          class="w-32 h-32 mb-8 drop-shadow-lg animate-bounce sm:w-20 sm:h-20"
        >
          <Icon name="tabler:cannabis" class="w-full h-full" />
        </div>
        <h2
          class="text-2xl font-bold text-primary-50 mb-4 drop-shadow-lg sm:text-xl"
        >
          {t("sessions.new.amount")}
        </h2>
        <div class="text-sm text-primary-50/80 font-medium">Step 3 of 5</div>
      </div>
      <div
        id="step-status"
        class="text-center mb-4 text-sm text-primary-50 whitespace-pre-line"
      >
      </div>
      <div
        class="w-full max-w-128 p-8 bg-primary-50 dark:bg-secondary-50 rounded-t-3xl shadow-lg"
      >
        <div class="flex items-center justify-center gap-6 mb-2">
          <button
            type="button"
            class="w-16 h-16 rounded-full border-2 border-primary-200 dark:border-secondary-200 bg-primary-50 dark:bg-secondary-50 text-2xl font-semibold text-primary-600 dark:text-secondary-600 cursor-pointer transition-all hover:bg-primary-600 dark:hover:bg-secondary-600 hover:text-primary-50 dark:hover:text-secondary-50 hover:border-primary-600 dark:hover:border-secondary-600 hover:scale-110 active:scale-95 flex items-center justify-center"
            data-action="decrease"
          >
            <span>âˆ’</span>
          </button>
          <input
            type="number"
            data-field="amount"
            class="w-30 p-4 text-4xl font-bold text-center border-none bg-transparent text-primary-900 dark:text-secondary-900 outline-none sm:text-2xl"
            value="0.0"
            step="0.1"
            min="0"
            max="10"
          />
          <button
            type="button"
            class="w-16 h-16 rounded-full border-2 border-primary-200 dark:border-secondary-200 bg-primary-50 dark:bg-secondary-50 text-2xl font-semibold text-primary-600 dark:text-secondary-600 cursor-pointer transition-all hover:bg-primary-600 dark:hover:bg-secondary-600 hover:text-primary-50 dark:hover:text-secondary-50 hover:border-primary-600 dark:hover:border-secondary-600 hover:scale-110 active:scale-95 flex items-center justify-center"
            data-action="increase"
          >
            <span>+</span>
          </button>
        </div>
        <div
          class="text-center text-base text-primary-500 dark:text-secondary-500 mb-4 font-medium"
        >
          g
        </div>
        <div class="flex gap-4 mt-4">
          <button
            type="button"
            class="flex-1 p-5 text-lg font-semibold border-2 border-primary-200 dark:border-secondary-200 rounded-xl cursor-pointer transition-all bg-primary-50 dark:bg-secondary-50 text-primary-700 dark:text-secondary-700 hover:bg-primary-100 dark:hover:bg-secondary-100"
            data-action="back"
          >
            Back
          </button>
          <button
            type="button"
            class="flex-1 p-5 text-lg font-semibold border-none rounded-xl cursor-pointer transition-all bg-gradient-to-r from-primary-600 to-secondary-600 text-primary-50 shadow-lg hover:shadow-xl hover:-translate-y-1 active:translate-y-0"
            data-action="next"
          >
            Continue
          </button>
        </div>
      </div>
    </div>

    <!-- Step 4: Select Effects -->
    <div
      class="absolute top-0 left-0 w-full h-full flex flex-col justify-between items-center opacity-0 translate-x-full transition-all duration-400 ease-in-out pointer-events-none"
      data-step="4"
    >
      <div
        class="flex-1 flex flex-col justify-center items-center p-8 text-center"
      >
        <div
          class="w-32 h-32 mb-8 drop-shadow-lg animate-bounce sm:w-20 sm:h-20"
        >
          <Icon name="tabler:cannabis" class="w-full h-full" />
        </div>
        <h2
          class="text-2xl font-bold text-primary-50 mb-4 drop-shadow-lg sm:text-xl"
        >
          {t("sessions.new.effects")}
        </h2>
        <div class="text-sm text-primary-50/80 font-medium">Step 4 of 5</div>
      </div>
      <div
        id="step-status"
        class="text-center mb-4 text-sm text-primary-50 whitespace-pre-line"
      >
      </div>
      <div
        class="w-full max-w-128 p-8 bg-primary-50 dark:bg-secondary-50 rounded-t-3xl shadow-lg"
      >
        <div class="grid grid-cols-2 gap-4">
          {
            ["relaxed", "energetic", "creative", "focused", "sleepy"].map(
              (effect) => (
                <label class="flex items-center gap-4 p-5 bg-primary-50 dark:bg-secondary-50 border-2 border-primary-200 dark:border-secondary-200 rounded-xl cursor-pointer transition-all font-medium text-lg hover:border-primary-600 dark:hover:border-secondary-600 hover:bg-primary-100 dark:hover:bg-secondary-100 text-primary-900 dark:text-secondary-900">
                  <input
                    type="checkbox"
                    data-field="effects"
                    value={effect}
                    class="w-5 h-5"
                  />
                  <span>{t(`sessions.effects.${effect}` as any)}</span>
                </label>
              ),
            )
          }
        </div>
        <div class="flex gap-4 mt-4">
          <button
            type="button"
            class="flex-1 p-5 text-lg font-semibold border-2 border-primary-200 dark:border-secondary-200 rounded-xl cursor-pointer transition-all bg-primary-50 dark:bg-secondary-50 text-primary-700 dark:text-secondary-700 hover:bg-primary-100 dark:hover:bg-secondary-100"
            data-action="back"
          >
            Back
          </button>
          <button
            type="button"
            class="flex-1 p-5 text-lg font-semibold border-none rounded-xl cursor-pointer transition-all bg-gradient-to-r from-primary-600 to-secondary-600 text-primary-50 shadow-lg hover:shadow-xl hover:-translate-y-1 active:translate-y-0"
            data-action="next"
          >
            Continue
          </button>
        </div>
      </div>
    </div>

    <!-- Step 5: Notes (Optional) -->
    <div
      class="absolute top-0 left-0 w-full h-full flex flex-col justify-between items-center opacity-0 translate-x-full transition-all duration-400 ease-in-out pointer-events-none"
      data-step="5"
    >
      <div
        class="flex-1 flex flex-col justify-center items-center p-8 text-center"
      >
        <div
          class="w-32 h-32 mb-8 drop-shadow-lg animate-bounce sm:w-20 sm:h-20"
        >
          <Icon name="tabler:cannabis" class="w-full h-full" />
        </div>
        <h2
          class="text-2xl font-bold text-primary-50 mb-4 drop-shadow-lg sm:text-xl"
        >
          {t("sessions.new.notes")}
        </h2>
        <div class="text-sm text-primary-50/80 font-medium">Step 5 of 5</div>
      </div>
      <div
        id="step-status"
        class="text-center mb-4 text-sm text-primary-50 whitespace-pre-line"
      >
      </div>
      <div
        class="w-full max-w-128 p-8 bg-primary-50 dark:bg-secondary-50 rounded-t-3xl shadow-lg"
      >
        <textarea
          data-field="notes"
          class="w-full p-5 text-base border-2 border-primary-200 dark:border-secondary-200 rounded-xl outline-none transition-all bg-primary-50 dark:bg-secondary-50 resize-none font-inherit mb-4 focus:border-primary-600 dark:focus:border-secondary-600 focus:bg-primary-50 dark:focus:bg-secondary-50 focus:shadow-lg text-primary-900 dark:text-secondary-900"
          placeholder={t("sessions.new.notes")}
          rows="4"></textarea>
        <div class="grid grid-cols-2 gap-4 mt-4">
          <button
            type="button"
            class="p-5 text-lg font-semibold border-2 border-primary-200 dark:border-secondary-200 rounded-xl cursor-pointer transition-all bg-primary-50 dark:bg-secondary-50 text-primary-700 dark:text-secondary-700 hover:bg-primary-100 dark:hover:bg-secondary-100"
            data-action="back"
          >
            Back
          </button>
          <button
            type="button"
            class="p-5 text-lg font-semibold border-none rounded-xl cursor-pointer transition-all bg-gradient-to-r from-primary-600 to-secondary-600 text-primary-50 shadow-lg hover:shadow-xl hover:-translate-y-1 active:translate-y-0 flex items-center justify-center gap-2"
            data-action="submit"
          >
            <span>{t("sessions.new.submit")}</span>
            <span id="submit-spinner" class="hidden">
              <svg
                class="animate-spin h-5 w-5 text-white"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
              >
                <circle
                  class="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  stroke-width="4"></circle>
                <path
                  class="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                ></path>
              </svg>
            </span>
          </button>
        </div>
      </div>
    </div>

    <!-- Error/Success Message -->
    <div
      id="wizard-error"
      class="hidden fixed bottom-4 left-1/2 transform -translate-x-1/2 p-4 text-red-700 bg-red-100 dark:bg-red-900 dark:text-red-100 rounded-lg shadow-lg"
      role="alert"
    >
      <p class="font-medium"></p>
    </div>
  </div>

  <script>
    import SessionWizard from "../../../scripts/sessionWizard.ts";
    new SessionWizard();
  </script>
</DashboardLayout>
